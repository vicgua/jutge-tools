# THIS FILE IS NOT INTENDED TO BE EDITED
# This Makefile is a general template; to configure it, edit the
# "build_conf.mk" file.
include build_conf.mk

# If your version of GNU tar is not named "tar", use "make TAR=gtar" (for
# example). Other versions such as BSD tar may also work, though.
TAR = tar

# Internal variables to simplify the Makefile
DEPS.cc = $(CXX) $(CXXFLAGS) $(CPPFLAGS) $(TARGET_ARCH)
DEPS.c = $(CC) $(CFLAGS) $(CPPFLAGS) $(TARGET_ARCH)

# We keep a list of objects generated by make, so only these will be deleted
# when doing "make clean".
built_objs = $(BUILD_DIR)/built_objs
ifeq ($(ORDERED_BUILD_OBJECTS),false)
addobject = echo $(1) >> $(built_objs)
prepare_build = mkdir -pv $(BUILD_DIR)
else
sort_bo = sort -uo $(built_objs)
addobject = echo $(1) | cat $(built_objs) - | $(sort_bo)
prepare_build = mkdir -pv $(BUILD_DIR) && touch $(built_objs)
endif

.PHONY: all
.DEFAULT: all
all: $(PROGRAMNAME) $(TARNAME)

.PHONY: clean
clean:
	@# The "read from file" is not the safest option, but is the easiest and
	@# most portable. Since this will run in YOUR system, you are responsible
	@# for having sanely named object files and not messing with
	@# $(BUILD_DIR)/built_objs
	@[ -f $(built_objs) ] && rm -v -- `< $(built_objs)` || true
	@rm -rvf $(BUILD_DIR)/*
	@[ -d $(BUILD_DIR) ] && rmdir -v $(BUILD_DIR) || true

.PHONY: exe
exe: $(PROGRAMNAME)

.PHONY: tar
tar: $(TARFILES)

%.o: %.cc
	@$(prepare_build)
	@# The following command generates a dependency file, with the headers
	@# that the source depends on, so that it will be recompiled if the
	@# source or any of it headers change.
	$(DEPS.cc) -MM -MF $(BUILD_DIR)/$@.d $<
	$(COMPILE.cc) -o $@ $<
	@$(call addobject,$@)

%.o: %.c
	@$(prepare_build)
	$(DEPS.c) -MM -MF $(BUILD_DIR)/$@.d $<
	$(COMPILE.c) -o $@ $<
	@$(call addobject,$@)

$(PROGRAMNAME): $(OBJECTS)
	@$(prepare_build)
	$(LINK.cc)   -o $@ $^
	@$(call addobject,$@)

$(TARNAME): $(TARFILES)
	@$(prepare_build)
ifeq ($(TARAPPEND), true)
	$(TAR)      $(TARFLAGS) -f $@ -r $?
else
	$(TAR)      $(TARFLAGS) -f $@ -c $^
endif
	@$(call addobject,$@)

-include $(BUILD_DIR)/*.d
